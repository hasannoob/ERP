<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ইউনিক ERP ইউজার প্যানেল</title>
    <style>
        :root {
            --primary-color: #27ae60;
            --secondary-color: #2ecc71;
            --background-color: #ecf0f1;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --text-color: #34495e;
            --card-bg: #ffffff;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .user-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid var(--sidebar-hover);
        }
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
            margin: 0;
            flex-grow: 1;
        }
        .sidebar-menu li a {
            display: flex;
            align-items: center;
            color: var(--sidebar-text);
            text-decoration: none;
            padding: 15px 20px;
            transition: background-color 0.3s;
            border-left: 4px solid transparent;
        }
        .sidebar-menu li a:hover {
            background-color: var(--sidebar-hover);
        }
        .sidebar-menu li a.active {
            background-color: var(--primary-color);
            border-left: 4px solid var(--sidebar-text);
            font-weight: bold;
        }
        .main-content {
            flex-grow: 1;
            padding: 25px;
        }
        .header h1 {
            margin: 0;
            font-size: 2rem;
            color: #2c3e50;
        }
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .btn {
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background: var(--secondary-color);
        }
        .btn.secondary {
            background: #7f8c8d;
        }
        .btn.secondary:hover {
            background: #95a5a6;
        }
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .filter-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-container input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 5px solid var(--primary-color);
        }
        .kpi-card.success { border-color: var(--secondary-color); }
        .kpi-card.danger { border-color: var(--danger-color); }
        .kpi-card h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        .kpi-card p {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-color);
        }
        .progress-list .list-header {
            display: grid;
            grid-template-columns: 3fr 1fr 2fr;
            font-weight: bold;
            padding: 10px 15px;
            color: #7f8c8d;
        }
        .progress-item {
            display: grid;
            grid-template-columns: 3fr 1fr 2fr;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        .progress-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .progress-bar-container {
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }
        .progress-bar {
            background-color: var(--primary-color);
            height: 100%;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
            transition: width 0.5s ease-in-out;
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
        }
        .styled-table thead tr {
            background-color: var(--primary-color);
            color: #ffffff;
            text-align: left;
        }
        .styled-table th,
        .styled-table td {
            padding: 12px 15px;
        }
        .styled-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }
        .styled-table tbody tr:hover {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="card" style="width: 400px;">
            <h2>ইউজার লগইন</h2>
            <div id="login-error" style="color: var(--danger-color); margin-bottom: 10px;"></div>
            <form onsubmit="loginUser(event)">
                <div class="form-group">
                    <label for="login-email">ইমেইল</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">পাসওয়ার্ড</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn">প্রবেশ করুন</button>
            </form>
        </div>
    </div>

    <div id="user-panel" class="user-container" style="display: none;">
        <nav class="sidebar">
            <div class="sidebar-header">ইউজার প্যানেল</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showPage('dashboard', this)">ড্যাশবোর্ড</a></li>
                <li><a href="#" onclick="showPage('production-entry', this)">প্রোডাকশন এন্ট্রি</a></li>
                <li><a href="#" onclick="showPage('production-fail', this)">প্রোডাকশন ফেল</a></li>
                <li><a href="#" onclick="showPage('packing-fail', this)">প্যাকিং ফেইল</a></li>
                <li><a href="#" onclick="showPage('packing-send', this)">প্যাকিং সেন্ড</a></li>
                <li><a href="#" onclick="showPage('packing-return', this)">প্যাকিং রিটার্ন</a></li>
                <li><a href="#" onclick="showPage('master-report', this)">মাস্টার রিপোর্ট</a></li>
                <li><a href="#" onclick="showPage('packing-send-master-report', this)">প্যাকিং সেন্ড রিপোর্ট</a></li>
                <li><a href="#" onclick="logoutUser()">লগআউট</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page-content">
                <div class="header"><h1>ড্যাশবোর্ড ওভারভিউ</h1></div>
                <div class="kpi-cards">
                    <div class="kpi-card"><h3>মোট টার্গেট</h3><p id="kpi-total-target">0</p></div>
                    <div class="kpi-card success"><h3>মোট প্রোডাকশন</h3><p id="kpi-total-production">0</p></div>
                    <div class="kpi-card success"><h3>সাফল্যের হার</h3><p id="kpi-achievement-rate">0%</p></div>
                    <div class="kpi-card danger"><h3>মোট ফেইল</h3><p id="kpi-total-fail">0</p></div>
                </div>
                <div class="card">
                    <h3>প্রোডাক্ট পারফরম্যান্স</h3>
                    <div class="progress-list">
                        <div class="list-header"><span>প্রোডাক্ট</span><span>টার্গেট</span><span>অগ্রগতি</span></div>
                        <div id="product-performance-list"></div>
                    </div>
                </div>
            </div>

            <!-- Production Entry Page -->
            <div id="production-entry" class="page-content">
                <div class="header"><h1>প্রোডাকশন এন্ট্রি</h1></div>
                <div class="card">
                    <form id="production-form" onsubmit="submitProductionEntry(event)">
                        <div class="form-group">
                            <label for="prod-model">মডেল, রঙ এবং ব্যাচ</label>
                            <select id="prod-model" required><option value="">লোড হচ্ছে...</option></select>
                        </div>
                        <div class="form-group">
                            <label for="entry-qty">এন্ট্রি পরিমাণ (পিস)</label>
                            <input type="number" id="entry-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn">এন্ট্রি জমা দিন</button>
                    </form>
                </div>
            </div>
            
            <!-- Packing Fail Page -->
            <div id="packing-fail" class="page-content">
                <div class="header"><h1>প্যাকিং ফেইল এন্ট্রি</h1></div>
                <div class="card">
                    <form id="packing-fail-form" onsubmit="submitPackingFail(event)">
                        <div class="form-group">
                            <label for="packing-fail-model">মডেল, রঙ এবং ব্যাচ</label>
                            <select id="packing-fail-model" required><option value="">লোড হচ্ছে...</option></select>
                        </div>
                        <div class="form-group">
                            <label for="packing-fail-qty">ফেল পরিমাণ (পিস)</label>
                            <input type="number" id="packing-fail-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--danger-color);">ফেল এন্ট্রি দিন</button>
                    </form>
                </div>
            </div>

            <!-- Production Fail Page -->
            <div id="production-fail" class="page-content">
                <div class="header"><h1>প্রোডাকশন ফেল এন্ট্রি</h1></div>
                <div class="card">
                    <form id="production-fail-form" onsubmit="submitProductionFail(event)">
                        <div class="form-group">
                            <label for="fail-model">মডেল, রঙ এবং ব্যাচ</label>
                            <select id="fail-model" required><option value="">লোড হচ্ছে...</option></select>
                        </div>
                        <div class="form-group">
                            <label for="fail-qty">ফেল পরিমাণ (পিস)</label>
                            <input type="number" id="fail-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--danger-color);">ফেল এন্ট্রি দিন</button>
                    </form>
                </div>
            </div>

            <!-- Packing Send Page -->
            <div id="packing-send" class="page-content">
                <div class="header"><h1>প্যাকিংয়ের জন্য পাঠান</h1></div>
                <div class="card">
                    <form id="packing-send-form" onsubmit="submitPackingSend(event)">
                        <div class="form-group">
                            <label for="packing-model">মডেল, রঙ এবং ব্যাচ</label>
                            <select id="packing-model" required><option value="">লোড হচ্ছে...</option></select>
                        </div>
                        <div class="form-group">
                            <label for="packing-qty">পাঠানোর পরিমাণ (পিস)</label>
                            <input type="number" id="packing-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn">প্যাকিংয়ে পাঠান</button>
                    </form>
                </div>
            </div>
            
            <!-- Packing Return Page -->
            <div id="packing-return" class="page-content">
                <div class="header"><h1>প্যাকিং রিটার্ন (ভালো প্রোডাক্ট)</h1></div>
                <div class="card">
                    <form id="packing-return-form" onsubmit="submitPackingReturn(event)">
                        <div class="form-group">
                            <label for="packing-return-model">মডেল, রঙ এবং ব্যাচ</label>
                            <select id="packing-return-model" required><option value="">লোড হচ্ছে...</option></select>
                        </div>
                        <div class="form-group">
                            <label for="packing-return-qty">রিটার্ন পরিমাণ (পিস)</label>
                            <input type="number" id="packing-return-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--warning-color);">রিটার্ন এন্ট্রি দিন</button>
                    </form>
                </div>
            </div>

            <!-- Master Report Page -->
            <div id="master-report" class="page-content">
                <div class="header"><h1>মাস্টার রিপোর্ট</h1></div>
                <div class="card">
                    <!-- নতুন ফিল্টার যুক্ত করা হয়েছে -->
                    <div class="filter-container">
                        <input type="text" id="filter-model" placeholder="মডেল দিয়ে খুঁজুন...">
                        <input type="text" id="filter-batch" placeholder="ব্যাচ নম্বর দিয়ে খুঁজুন...">
                        <button class="btn" onclick="fetchMasterReport()">ফিল্টার করুন</button>
                        <button class="btn secondary" onclick="resetMasterReportFilter()">রিসেট</button>
                    </div>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>মডেলের নাম</th>
                                <th>ব্যাচ নং</th>
                                <th>রঙ</th>
                                <th>টার্গেট</th>
                                <th>ইন-হ্যান্ড</th>
                                <th>প্যাকিংয়ে পাঠানো</th>
                                <th>মোট ফেইল</th>
                                <th>বাকি</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Packing Send Master Report Page -->
            <div id="packing-send-master-report" class="page-content">
                <div class="header"><h1>প্যাকিং সেন্ড মাস্টার রিপোর্ট</h1></div>
                <div class="card">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>তারিখ</th>
                                <th>মডেলের নাম</th>
                                <th>ব্যাচ নং</th>
                                <th>রঙ</th>
                                <th>পরিমাণ</th>
                            </tr>
                        </thead>
                        <tbody id="packing-report-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCaVR0gMKOMCMUQHPcchZVzP8Z2xeXmqR4", // অনুগ্রহ করে এই কী পরিবর্তন করুন
            authDomain: "erp-acb6b.firebaseapp.com",
            databaseURL: "https://erp-acb6b-default-rtdb.firebaseio.com",
            projectId: "erp-acb6b",
            storageBucket: "erp-acb6b.appspot.com",
            messagingSenderId: "224077695495",
            appId: "1:224077695495:web:dce4ed9fed907e8e5fb8a2",
            measurementId: "G-BQ8R96S97S"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variable to store all materials data for client-side filtering
        let allMaterialsData = [];

        function showPage(pageId, element) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (element) {
                document.querySelectorAll('.sidebar-menu a').forEach(link => link.classList.remove('active'));
                element.classList.add('active');
            }
            
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'production-entry') loadProductionForm();
            if (pageId === 'packing-fail') loadPackingFailForm();
            if (pageId === 'production-fail') loadProductionFailForm(); 
            if (pageId === 'packing-send') loadPackingSendForm(); 
            if (pageId === 'packing-return') loadPackingReturnForm();
            if (pageId === 'master-report') {
                // Fetch all data initially when page is loaded
                fetchAllMaterialsAndRenderReport();
            }
            if (pageId === 'packing-send-master-report') fetchPackingSendMasterReport(); 
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('user-panel').style.display = 'flex';
                showPage('dashboard', document.querySelector('.sidebar-menu a'));
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('user-panel').style.display = 'none';
            }
        });

        function loginUser(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    document.getElementById('login-error').textContent = 'ভুল ইমেইল বা পাসওয়ার্ড।';
                });
        }

        function logoutUser() { auth.signOut(); }

        // --- Dashboard Logic ---
        async function loadDashboard() {
            const snapshot = await db.collection('materials').get();
            let totalTarget = 0, totalProduction = 0, totalFail = 0;
            let performanceHtml = '';
            
            snapshot.forEach(doc => {
                const item = doc.data();
                const target = item.targetQty || 0;
                const inHand = item.inHandQty || 0;
                const packingSent = item.packingSentQty || 0;
                const faulty = item.faultyQty || 0; 
                const fail = item.failQty || 0;
                const achievement = inHand + packingSent;

                totalTarget += target;
                totalProduction += achievement;
                totalFail += (faulty + fail);
                
                const progress = target > 0 ? (achievement / target) * 100 : 0;
                performanceHtml += `
                    <div class="progress-item">
                        <span>${item.modelName} - ${item.color} (ব্যাচ: ${item.batchNo || 'N/A'})</span>
                        <span>${target}</span>
                        <div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progress.toFixed(2)}%;">${progress.toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('kpi-total-target').textContent = totalTarget;
            document.getElementById('kpi-total-production').textContent = totalProduction;
            document.getElementById('kpi-total-fail').textContent = totalFail;
            const achievementRate = totalTarget > 0 ? (totalProduction / totalTarget) * 100 : 0;
            document.getElementById('kpi-achievement-rate').textContent = `${achievementRate.toFixed(1)}%`;
            document.getElementById('product-performance-list').innerHTML = performanceHtml;
        }


        // --- Form Loading ---
        async function loadSelectOptions(selectElementId) {
            const selectElement = document.getElementById(selectElementId);
            selectElement.innerHTML = '<option value="">লোড হচ্ছে...</option>';
            const snapshot = await db.collection('materials').orderBy('modelName').get();
            let optionsHtml = '<option value="">-- একটি মডেল নির্বাচন করুন --</option>';
            snapshot.forEach(doc => {
                const item = doc.data();
                // ডেটাসেটে ব্যাচ নম্বর যোগ করা হয়েছে
                optionsHtml += `<option value="${doc.id}" 
                                        data-model="${item.modelName}" 
                                        data-color="${item.color}" 
                                        data-batch="${item.batchNo || ''}">
                                    ${item.modelName} - ${item.color} (ব্যাচ: ${item.batchNo || 'N/A'})
                                </option>`;
            });
            selectElement.innerHTML = optionsHtml;
        }

        function loadProductionForm() { loadSelectOptions('prod-model'); }
        function loadPackingFailForm() { loadSelectOptions('packing-fail-model'); }
        function loadProductionFailForm() { loadSelectOptions('fail-model'); }
        function loadPackingSendForm() { loadSelectOptions('packing-model'); }
        function loadPackingReturnForm() { loadSelectOptions('packing-return-model'); }

        // --- Data Submission Logic (Generic Handler) ---
        async function handleTransaction(formId, modelId, qtyId, updateLogic, successMsg, errorMsg) {
             event.preventDefault();
            const modelDocId = document.getElementById(modelId).value;
            const quantity = Number(document.getElementById(qtyId).value);

            if (!modelDocId || quantity <= 0) {
                alert('অনুগ্রহ করে সঠিক মডেল এবং পরিমাণ দিন।');
                return;
            }
            
            const docRef = db.collection('materials').doc(modelDocId);

            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (!doc.exists) throw "ডকুমেন্ট পাওয়া যায়নি!";
                    await updateLogic(transaction, doc, quantity, docRef);
                });
                alert(successMsg);
                document.getElementById(formId).reset();
            } catch (error) {
                alert(`${errorMsg}: ${error}`);
            }
        }
        
        function submitProductionEntry(event) {
            handleTransaction('production-form', 'prod-model', 'entry-qty', 
                (trans, doc, qty, ref) => trans.update(ref, { inHandQty: firebase.firestore.FieldValue.increment(qty) }),
                'প্রোডাকশন সফলভাবে এন্ট্রি হয়েছে!', 'এন্ট্রি করতে সমস্যা হয়েছে'
            );
        }

        function submitPackingFail(event) {
            handleTransaction('packing-fail-form', 'packing-fail-model', 'packing-fail-qty',
                (trans, doc, qty, ref) => {
                    const currentPackingSent = doc.data().packingSentQty || 0;
                    if (qty > currentPackingSent) throw `ফেল পরিমাণ (${qty}) প্যাকিংয়ে পাঠানো (${currentPackingSent}) পরিমাণের চেয়ে বেশি হতে পারে না।`;
                    trans.update(ref, {
                        packingSentQty: firebase.firestore.FieldValue.increment(-qty),
                        faultyQty: firebase.firestore.FieldValue.increment(qty)
                    });
                },
                'প্যাকিং ফেইল সফলভাবে জমা হয়েছে!', 'এন্ট্রি করতে সমস্যা হয়েছে'
            );
        }
        
        function submitProductionFail(event) {
            handleTransaction('production-fail-form', 'fail-model', 'fail-qty', 
                (trans, doc, qty, ref) => trans.update(ref, { failQty: firebase.firestore.FieldValue.increment(qty) }),
                'প্রোডাকশন ফেল সফলভাবে এন্ট্রি হয়েছে!', 'এন্ট্রি করতে সমস্যা হয়েছে'
            );
        }
        
        async function submitPackingSend(event) {
            event.preventDefault();
            const select = document.getElementById('packing-model');
            const modelDocId = select.value;
            const quantity = Number(document.getElementById('packing-qty').value);

            if (!modelDocId || quantity <= 0) {
                alert('অনুগ্রহ করে সঠিক মডেল এবং পরিমাণ দিন।'); return;
            }
            
            const option = select.options[select.selectedIndex];
            const modelName = option.dataset.model;
            const color = option.dataset.color;
            const batchNo = option.dataset.batch; // ব্যাচ নম্বর সংগ্রহ

            const materialDocRef = db.collection('materials').doc(modelDocId);

            try {
                await db.runTransaction(async (transaction) => {
                    const materialDoc = await transaction.get(materialDocRef);
                    if (!materialDoc.exists) throw "প্রোডাক্ট পাওয়া যায়নি!";
                    
                    const currentInHand = materialDoc.data().inHandQty || 0;
                    if (quantity > currentInHand) throw `পাঠানোর পরিমাণ (${quantity}) বর্তমান স্টকের (${currentInHand}) চেয়ে বেশি হতে পারে না।`;
                    
                    transaction.update(materialDocRef, {
                        inHandQty: firebase.firestore.FieldValue.increment(-quantity),
                        packingSentQty: firebase.firestore.FieldValue.increment(quantity)
                    });

                    const packingSendRef = db.collection('packing_sends').doc();
                    transaction.set(packingSendRef, { // ব্যাচ নম্বর সেভ করা হচ্ছে
                        materialId: modelDocId, modelName, color, batchNo, quantity,
                        sentAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                alert('সফলভাবে প্যাকিংয়ের জন্য পাঠানো হয়েছে!');
                document.getElementById('packing-send-form').reset();
            } catch (error) {
                alert('প্রেরণ করতে একটি সমস্যা হয়েছে: ' + error);
            }
        }

        function submitPackingReturn(event) {
             handleTransaction('packing-return-form', 'packing-return-model', 'packing-return-qty',
                (trans, doc, qty, ref) => {
                    const currentPackingSent = doc.data().packingSentQty || 0;
                    if (qty > currentPackingSent) throw `রিটার্নের পরিমাণ (${qty}) প্যাকিংয়ে পাঠানো (${currentPackingSent}) পরিমাণের চেয়ে বেশি হতে পারে না।`;
                    trans.update(ref, {
                        packingSentQty: firebase.firestore.FieldValue.increment(-quantity),
                        inHandQty: firebase.firestore.FieldValue.increment(quantity)
                    });
                },
                'সফলভাবে প্যাকিং থেকে রিটার্ন করা হয়েছে!', 'রিটার্ন করতে সমস্যা হয়েছে'
            );
        }

        // --- Master Report with Filtering ---
        async function fetchAllMaterialsAndRenderReport() {
            const reportTableBody = document.getElementById('report-table-body');
            reportTableBody.innerHTML = `<tr><td colspan="8">লোড হচ্ছে...</td></tr>`;
            const snapshot = await db.collection('materials').orderBy('createdAt', 'desc').get();
            allMaterialsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMasterReport(allMaterialsData);
        }

        function fetchMasterReport() {
            const modelFilter = document.getElementById('filter-model').value.toLowerCase();
            const batchFilter = document.getElementById('filter-batch').value.toLowerCase();

            const filteredData = allMaterialsData.filter(item => {
                const modelMatch = modelFilter ? (item.modelName || '').toLowerCase().includes(modelFilter) : true;
                const batchMatch = batchFilter ? (item.batchNo || '').toLowerCase().includes(batchFilter) : true;
                return modelMatch && batchMatch;
            });

            renderMasterReport(filteredData);
        }

        function renderMasterReport(data) {
            const reportTableBody = document.getElementById('report-table-body');
            let tableHtml = '';
            if (data.length === 0) {
                 reportTableBody.innerHTML = `<tr><td colspan="8">কোনো ডেটা পাওয়া যায়নি।</td></tr>`;
                 return;
            }
            data.forEach(item => {
                const target = item.targetQty || 0;
                const inHand = item.inHandQty || 0;
                const packingSent = item.packingSentQty || 0;
                const totalFail = (item.faultyQty || 0) + (item.failQty || 0);
                const achievement = inHand + packingSent;
                const remaining = target - achievement;
                tableHtml += `
                    <tr>
                        <td>${item.modelName}</td>
                        <td>${item.batchNo || 'N/A'}</td>
                        <td>${item.color}</td>
                        <td>${target}</td>
                        <td>${inHand}</td>
                        <td>${packingSent}</td>
                        <td>${totalFail}</td>
                        <td>${remaining > 0 ? remaining : 0}</td>
                    </tr>
                `;
            });
            reportTableBody.innerHTML = tableHtml;
        }
        
        function resetMasterReportFilter() {
            document.getElementById('filter-model').value = '';
            document.getElementById('filter-batch').value = '';
            renderMasterReport(allMaterialsData);
        }
        
        async function fetchPackingSendMasterReport() {
            const reportTableBody = document.getElementById('packing-report-table-body');
            reportTableBody.innerHTML = '<tr><td colspan="5">লোড হচ্ছে...</td></tr>';
            const snapshot = await db.collection('packing_sends').orderBy('sentAt', 'desc').get();
            let tableHtml = '';
            snapshot.forEach(doc => {
                const item = doc.data();
                const date = item.sentAt ? item.sentAt.toDate().toLocaleString('bn-BD') : 'N/A';
                tableHtml += `
                    <tr>
                        <td>${date}</td>
                        <td>${item.modelName}</td>
                        <td>${item.batchNo || 'N/A'}</td>
                        <td>${item.color}</td>
                        <td>${item.quantity}</td>
                    </tr>
                `;
            });
            reportTableBody.innerHTML = tableHtml;
        }

    </script>
</body>
</html>
