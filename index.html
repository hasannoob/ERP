<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unique ERP User Panel</title>
    <!-- Chart.js লাইব্রেরি যোগ করা হয়েছে -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #27ae60; --secondary-color: #2ecc71; --background-color: #ecf0f1;
            --sidebar-bg: #2c3e50; --sidebar-text: #ecf0f1; --sidebar-hover: #34495e;
            --text-color: #34495e; --card-bg: #ffffff; --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --danger-color: #e74c3c; --warning-color: #f39c12; --info-color: #3498db;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        .user-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid var(--sidebar-hover); }
        .sidebar-menu { list-style: none; padding: 20px 0; margin: 0; flex-grow: 1; }
        .sidebar-menu li a { display: flex; align-items: center; color: var(--sidebar-text); text-decoration: none; padding: 15px 20px; transition: background-color: 0.3s; border-left: 4px solid transparent; }
        .sidebar-menu li a:hover { background-color: var(--sidebar-hover); }
        .sidebar-menu li a.active { background-color: var(--primary-color); border-left: 4px solid var(--sidebar-text); font-weight: bold; }
        .main-content { flex-grow: 1; padding: 25px; }
        .header h1 { margin: 0; font-size: 2rem; color: #2c3e50; }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { background: var(--primary-color); color: white; padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95rem; font-weight: bold; }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .kpi-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: left; border-left: 5px solid var(--primary-color); }
        .kpi-card h3 { margin: 0 0 10px 0; font-size: 1rem; color: #7f8c8d; text-transform: uppercase; }
        .kpi-card p { margin: 0; font-size: 2.2rem; font-weight: 700; }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table thead tr { background-color: var(--primary-color); color: #ffffff; }
        .styled-table th, .styled-table td { padding: 12px 15px; border-bottom: 1px solid #dddddd; text-align: left; }
        .autocomplete-container { position: relative; }
        .autocomplete-items { position: absolute; border: 1px solid #d4d4d4; z-index: 99; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background-color: #fff; }
        .autocomplete-items div { padding: 10px; cursor: pointer; border-bottom: 1px solid #d4d4d4; }
        .permission-denied-card { text-align: center; padding: 50px; }
        .permission-denied-card h1 { color: var(--danger-color); }
        .notification-badge { background-color: var(--danger-color); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8rem; margin-left: 8px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .chart-container { grid-column: 1 / 3; }
        .data-list-container { grid-column: 3 / 4; display: flex; flex-direction: column; gap: 20px; }
        .performance-table td:last-child { font-weight: bold; }
        .good-performance { color: var(--primary-color); }
        .bad-performance { color: var(--danger-color); }
        .activity-log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .activity-log-item:last-child { border-bottom: none; }
        .activity-log-item .time { font-size: 0.8rem; color: #7f8c8d; }
        .report-controls-wrapper { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .filter-container { flex-grow: 1; }
        .filter-options { display: none; background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-options.active { display: flex; }
        .filter-options .form-group { margin-bottom: 0; flex-grow: 1; min-width: 200px; }
        .print-button-container { margin-left: 20px; }
        #print-header { display: none; text-align: center; margin-bottom: 20px; }
        
        @media (max-width: 992px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .chart-container, .data-list-container { grid-column: auto; }
        }

        @media print {
            body * { visibility: hidden; }
            .main-content, #master-report, #master-report .card, #master-report .card * { visibility: visible; }
            #user-panel { display: block !important; }
            .main-content { padding: 0; }
            #master-report { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
            .sidebar, .header, .report-controls-wrapper { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            #print-header { display: block; }
        }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="card" style="width: 400px;">
            <h2>User Login</h2>
            <div id="login-error" style="color: var(--danger-color); margin-bottom: 10px;"></div>
            <form onsubmit="loginUser(event)">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                <button type="submit" class="btn" style="width:100%">Login</button>
            </form>
        </div>
    </div>

    <div id="user-panel" class="user-container" style="display: none;">
        <nav class="sidebar">
            <div class="sidebar-header">User Panel</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showPage('dashboard', this)">Dashboard</a></li>
                <li><a href="#" onclick="showPage('production-entry', this)">Production Entry</a></li>
                <li><a href="#" onclick="showPage('receive-production', this)">Receive Production<span id="reception-noti" class="notification-badge" style="display:none;"></span></a></li>
                <li><a href="#" onclick="showPage('packing-send', this)">Send to Packing</a></li>
                <li><a href="#" onclick="showPage('packing-receive', this)">Receive for Packing<span id="packing-receive-noti" class="notification-badge" style="display:none;"></span></a></li>
                <li><a href="#" onclick="showPage('production-fail', this)">Production Fail</a></li>
                <li><a href="#" onclick="showPage('packing-fail', this)">Packing Fail</a></li>
                <li><a href="#" onclick="showPage('fail-to-good', this)">Fail to Good</a></li>
                <li><a href="#" onclick="showPage('packing-return', this)">Packing Return</a></li>
                <li><a href="#" onclick="showPage('master-report', this)">Master Report</a></li>
                <li><a href="#" onclick="showPage('packing-send-report', this)">Packing Send Report</a></li>
                <li><a href="#" onclick="logoutUser()">Logout</a></li>
            </ul>
        </nav>
        <main class="main-content">
            <div id="dashboard" class="page-content">
                <div class="header"><h1>Dashboard Overview</h1></div>
                <div class="kpi-cards">
                     <div class="kpi-card" style="border-color: var(--primary-color);"><h3>Target Achievement</h3><p id="kpi-achievement">0%</p></div>
                    <div class="kpi-card" style="border-color: var(--secondary-color);"><h3>Total Production</h3><p id="kpi-total-production">0</p></div>
                    <div class="kpi-card" style="border-color: var(--info-color);"><h3>In Warehouse Stock</h3><p id="kpi-total-in-hand">0</p></div>
                    <div class="kpi-card" style="border-color: var(--danger-color);"><h3>Total Failures</h3><p id="kpi-total-fail">0</p></div>
                </div>
                <div class="dashboard-grid">
                    <div class="chart-container">
                        <div class="card">
                            <h3>Production vs Target by Model</h3>
                            <canvas id="productionChart"></canvas>
                        </div>
                    </div>
                    <div class="data-list-container">
                        <div class="card">
                            <h3>Stock Distribution</h3>
                            <canvas id="stockDonutChart"></canvas>
                        </div>
                        <div class="card">
                            <h3>Recent Activities</h3>
                            <div id="recent-activity-log"></div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card">
                        <h3>Top 5 Performing Models</h3>
                        <table class="styled-table performance-table">
                            <thead><tr><th>Model</th><th>Achievement</th></tr></thead>
                            <tbody id="top-models-table"></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h3>Top 5 Models Needing Attention</h3>
                        <table class="styled-table performance-table">
                            <thead><tr><th>Model</th><th>Achievement</th></tr></thead>
                            <tbody id="attention-models-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="production-entry" class="page-content">
                <div class="header"><h1>Production Entry</h1></div>
                <div class="card">
                    <form id="production-form" onsubmit="submitProductionEntry(event)">
                        <div class="form-group autocomplete-container">
                            <label for="prod-model-search">Search Model, Color & Batch</label>
                            <input type="text" id="prod-model-search" placeholder="Type to search..." autocomplete="off">
                            <input type="hidden" id="prod-model-id">
                            <div class="autocomplete-items" id="prod-model-results"></div>
                        </div>
                        <div class="form-group">
                            <label for="entry-qty">Entry Quantity (pcs)</label>
                            <input type="number" id="entry-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn">Submit Entry</button>
                    </form>
                </div>
            </div>

            <div id="receive-production" class="page-content">
                <div class="header"><h1>Receive Production from Factory</h1></div>
                <div class="card">
                    <table class="styled-table">
                        <thead><tr><th>Date</th><th>Model</th><th>Batch No.</th><th>Color</th><th>Quantity</th><th>Action</th></tr></thead>
                        <tbody id="receive-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="packing-receive" class="page-content">
                <div class="header"><h1>Receive Items for Packing</h1></div>
                <div class="card">
                     <table class="styled-table">
                        <thead><tr><th>Date Sent</th><th>Model</th><th>Batch No.</th><th>Color</th><th>Quantity</th><th>Action</th></tr></thead>
                        <tbody id="packing-receive-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="production-fail" class="page-content">
                <div class="header"><h1>Production Fail Entry</h1></div>
                <div class="card">
                    <form id="fail-form" onsubmit="submitProductionFail(event)">
                        <div class="form-group autocomplete-container">
                            <label for="fail-model-search">Search Model, Color & Batch</label>
                            <input type="text" id="fail-model-search" placeholder="Type to search..." autocomplete="off">
                            <input type="hidden" id="fail-model-id">
                            <div class="autocomplete-items" id="fail-model-results"></div>
                        </div>
                        <div class="form-group">
                            <label for="fail-qty">Fail Quantity (pcs)</label>
                            <input type="number" id="fail-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--danger-color);">Submit Fail Entry</button>
                    </form>
                </div>
            </div>
            
            <div id="packing-fail" class="page-content">
                <div class="header"><h1>Packing Fail Entry</h1></div>
                <div class="card">
                    <form id="packing-fail-form" onsubmit="submitPackingFail(event)">
                        <div class="form-group autocomplete-container">
                            <label for="packing-fail-model-search">Search Model, Color & Batch</label>
                            <input type="text" id="packing-fail-model-search" placeholder="Type to search..." autocomplete="off">
                            <input type="hidden" id="packing-fail-model-id">
                            <div class="autocomplete-items" id="packing-fail-model-results"></div>
                        </div>
                        <div class="form-group">
                            <label for="packing-fail-qty">Fail Quantity (pcs)</label>
                            <input type="number" id="packing-fail-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--danger-color);">Submit Fail Entry</button>
                    </form>
                </div>
            </div>

            <div id="fail-to-good" class="page-content">
                <div class="header"><h1>Convert Failed Product to Good Stock</h1></div>
                <div class="card">
                    <form id="fail-to-good-form" onsubmit="submitFailToGood(event)">
                        <div class="form-group autocomplete-container">
                            <label for="f2g-model-search">Search Model, Color & Batch</label>
                            <input type="text" id="f2g-model-search" placeholder="Type to search for a product with failed items..." autocomplete="off">
                            <input type="hidden" id="f2g-model-id">
                            <div class="autocomplete-items" id="f2g-model-results"></div>
                        </div>
                        <div class="form-group">
                            <label for="f2g-fail-type">Source of Failed Items</label>
                            <select id="f2g-fail-type" required>
                                <option value="production">From Production Fail</option>
                                <option value="packing">From Packing Fail</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="f2g-qty">Quantity to Convert (pcs)</label>
                            <input type="number" id="f2g-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--info-color);">Convert to Good Stock</button>
                    </form>
                </div>
            </div>

            <div id="packing-send" class="page-content">
                <div class="header"><h1>Send to Packing</h1></div>
                <div class="card">
                    <form id="packing-send-form" onsubmit="submitPackingSend(event)">
                        <div class="form-group autocomplete-container">
                            <label for="packing-send-model-search">Search Model, Color & Batch</label>
                            <input type="text" id="packing-send-model-search" placeholder="Type to search..." autocomplete="off">
                            <input type="hidden" id="packing-send-model-id">
                            <div class="autocomplete-items" id="packing-send-model-results"></div>
                        </div>
                        <div class="form-group">
                            <label for="packing-send-qty">Send Quantity (pcs)</label>
                            <input type="number" id="packing-send-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn">Send to Packing</button>
                    </form>
                </div>
            </div>

            <div id="packing-return" class="page-content">
                <div class="header"><h1>Packing Return (Good Product)</h1></div>
                <div class="card">
                    <form id="packing-return-form" onsubmit="submitPackingReturn(event)">
                        <div class="form-group autocomplete-container">
                             <label for="packing-return-model-search">Search Model, Color & Batch</label>
                            <input type="text" id="packing-return-model-search" placeholder="Type to search..." autocomplete="off">
                            <input type="hidden" id="packing-return-model-id">
                            <div class="autocomplete-items" id="packing-return-model-results"></div>
                        </div>
                        <div class="form-group">
                            <label for="packing-return-qty">Return Quantity (pcs)</label>
                            <input type="number" id="packing-return-qty" min="1" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--warning-color);">Submit Return Entry</button>
                    </form>
                </div>
            </div>

            <div id="master-report" class="page-content">
                <div class="header"><h1>Master Report</h1></div>
                <div id="print-header">
                    <h2>Linnex Electronics BD Ltd</h2>
                    <p>Master Stock Report</p>
                </div>
                <div class="card">
                    <div class="report-controls-wrapper">
                        <div class="filter-container">
                            <button class="btn" onclick="toggleFilterSection()">Show/Hide Filters</button>
                            <div id="filter-options" class="filter-options">
                                <div class="form-group"><label for="filter-model">Model Name</label><input type="text" id="filter-model" placeholder="Enter model name..."></div>
                                <div class="form-group"><label for="filter-batch">Batch No.</label><input type="text" id="filter-batch" placeholder="Enter batch no..."></div>
                                <button class="btn" onclick="applyMasterReportFilters()">Apply Filter</button>
                                <button class="btn" onclick="clearMasterReportFilters()" style="background: var(--warning-color);">Clear</button>
                            </div>
                        </div>
                        <div class="print-button-container">
                             <button class="btn" onclick="window.print()" style="background: var(--info-color);">Print Report</button>
                        </div>
                    </div>
                    <table class="styled-table">
                        <thead id="master-report-head"></thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="packing-send-report" class="page-content">
                <div class="header"><h1>Packing Send Master Report</h1></div>
                <div class="card">
                    <table class="styled-table">
                        <thead><tr><th>Date</th><th>Model Name</th><th>Batch No.</th><th>Color</th><th>Quantity</th></tr></thead>
                        <tbody id="packing-report-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="permission-denied" class="page-content">
                <div class="card permission-denied-card">
                    <h1>Permission Denied</h1>
                    <p>আপনার এই পৃষ্ঠাটি দেখার অনুমতি নেই।</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- Firebase Config and Initialization ---
        const firebaseConfig = { apiKey: "AIzaSyC1gLXDKHtkMV2s5ZsRlrHF8MiuP_pQnCo", authDomain: "erp-22158.firebaseapp.com", projectId: "erp-22158", storageBucket: "erp-22158.appspot.com", messagingSenderId: "87466207491", appId: "1:87466207491:web:e1edbb1910f59cb3cf6136" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global Variables ---
        let currentUserPermissions = {};
        let allMaterials = [];
        let productionChartInstance = null;
        let stockDonutChartInstance = null;

        const pagePermissionMapping = { 
            'dashboard': 'viewDashboard', 'production-entry': 'canEnterProduction', 
            'receive-production': 'canReceiveProduction', 'packing-receive': 'canReceiveForPacking',
            'production-fail': 'canEnterProductionFail', 'packing-fail': 'canEnterPackingFail', 
            'fail-to-good': 'canFixFailures', 'packing-send': 'canSendToPacking', 
            'packing-return': 'canReturnFromPacking', 'master-report': 'viewMasterReport', 
            'packing-send-report': 'viewPackingReport' 
        };

        // --- Authentication and Page Navigation ---
        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().permissions) {
                        currentUserPermissions = doc.data().permissions;
                        document.getElementById('login-page').style.display = 'none';
                        document.getElementById('user-panel').style.display = 'flex';
                        showPage('dashboard', document.querySelector('.sidebar-menu a'));
                        fetchAllMaterials();
                        setupNotificationListeners();
                    } else {
                        alert("Access Denied. Your user profile is not configured with permissions."); logoutUser();
                    }
                });
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('user-panel').style.display = 'none';
            }
        });

        function loginUser(event) {
            event.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
                .catch(err => document.getElementById('login-error').textContent = 'Incorrect email or password.');
        }

        function logoutUser() { auth.signOut(); }

        function showPage(pageId, el) {
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            if(el) el.classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            
            const requiredPermission = pagePermissionMapping[pageId];
            if (currentUserPermissions[requiredPermission] !== false) {
                document.getElementById(pageId).classList.add('active');
                if (pageId === 'dashboard') loadDashboard();
                if (pageId === 'master-report') renderMasterReport();
                if (pageId === 'packing-send-report') fetchPackingSendReport();
                if (pageId === 'receive-production') fetchPendingReceptions();
                if (pageId === 'packing-receive') fetchPendingPackingItems();
            } else {
                document.getElementById('permission-denied').classList.add('active');
            }
        }
        
        // --- Data Fetching and Setup ---
        async function fetchAllMaterials() {
            const snapshot = await db.collection('materials').orderBy('createdAt', 'desc').get();
            allMaterials = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setupAllAutocompletes();
            if (document.getElementById('dashboard').classList.contains('active')) {
                loadDashboard();
            }
            if (document.getElementById('master-report').classList.contains('active')) {
                renderMasterReport();
            }
        }

        function setupAllAutocompletes() {
            setupAutocomplete('prod-model-search', 'prod-model-id', 'prod-model-results');
            setupAutocomplete('fail-model-search', 'fail-model-id', 'fail-model-results');
            setupAutocomplete('packing-fail-model-search', 'packing-fail-model-id', 'packing-fail-model-results');
            setupAutocomplete('packing-send-model-search', 'packing-send-model-id', 'packing-send-model-results');
            setupAutocomplete('packing-return-model-search', 'packing-return-model-id', 'packing-return-model-results');
            setupAutocomplete('f2g-model-search', 'f2g-model-id', 'f2g-model-results');
        }

        function setupAutocomplete(inputId, hiddenId, resultId) {
            const searchInput = document.getElementById(inputId);
            if (!searchInput) return;
            searchInput.oninput = () => {
                const query = searchInput.value.toLowerCase();
                const resultsContainer = document.getElementById(resultId);
                resultsContainer.innerHTML = '';
                if (!query) return;
                const filtered = allMaterials.filter(item => `${item.modelName} ${item.color} ${item.batchNo || ''}`.toLowerCase().includes(query));
                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = `${item.modelName} - ${item.color} (Batch: ${item.batchNo || 'N/A'})`;
                    div.onclick = () => {
                        searchInput.value = div.textContent;
                        document.getElementById(hiddenId).value = item.id;
                        resultsContainer.innerHTML = '';
                    };
                    resultsContainer.appendChild(div);
                });
            };
             document.addEventListener('click', (e) => { if (!e.target.closest('.autocomplete-container')) { document.getElementById(resultId).innerHTML = ''; } });
        }
        
        // --- Transaction and Form Submission Logic ---
        async function handleTransaction(formId, modelId, qtyId, updateLogic, successMsg) {
            event.preventDefault();
            const docId = document.getElementById(modelId).value, qty = Number(document.getElementById(qtyId).value);
            if (!docId || qty <= 0) { alert("Please select a model and enter quantity."); return; }
            const docRef = db.collection('materials').doc(docId);
            try {
                await db.runTransaction(async (t) => {
                    const doc = await t.get(docRef);
                    if (!doc.exists) throw "Product not found!";
                    await updateLogic(t, doc, qty, docRef);
                });
                alert(successMsg);
                document.getElementById(formId).reset();
                allMaterials = [];
                await fetchAllMaterials();
            } catch (error) { alert(`Error: ${error}`); }
        }

        async function submitProductionEntry(event) {
            event.preventDefault();
            const docId = document.getElementById('prod-model-id').value;
            const qty = Number(document.getElementById('entry-qty').value);
            if (!docId || qty <= 0) { alert("Please select a model and enter quantity."); return; }
            const materialRef = db.collection('materials').doc(docId);
            const productionEntryRef = db.collection('production_entries').doc();
            try {
                const materialDoc = await materialRef.get();
                if (!materialDoc.exists) throw "Product not found!";
                const materialData = materialDoc.data();
                await db.runTransaction(async (transaction) => {
                    transaction.set(productionEntryRef, {
                        materialId: docId, modelName: materialData.modelName, color: materialData.color,
                        batchNo: materialData.batchNo || 'N/A', quantity: qty, status: 'pending',
                        producedAt: firebase.firestore.FieldValue.serverTimestamp(), producedBy: auth.currentUser.email
                    });
                    transaction.update(materialRef, { pendingReceptionQty: firebase.firestore.FieldValue.increment(qty) });
                });
                alert('Production entry submitted for reception!');
                document.getElementById('production-form').reset();
                await fetchAllMaterials();
            } catch (error) { alert(`Error: ${error}`); }
        }

        function submitProductionFail(event) { handleTransaction('fail-form', 'fail-model-id', 'fail-qty', (t, d, q, ref) => t.update(ref, { failQty: firebase.firestore.FieldValue.increment(q) }), 'Fail entry submitted.'); }
        
        function submitPackingFail(event) { 
            handleTransaction('packing-fail-form', 'packing-fail-model-id', 'packing-fail-qty', (t, d, q, ref) => { 
                const availableStock = (d.data().packingStockQty || 0) + (d.data().pendingPackingQty || 0);
                if (q > availableStock) throw "Fail quantity exceeds quantity in the packing process."; 
                t.update(ref, { 
                    packingStockQty: firebase.firestore.FieldValue.increment(-q), 
                    faultyQty: firebase.firestore.FieldValue.increment(q) 
                }); 
            }, 'Packing fail submitted.'); 
        }

        function submitPackingReturn(event) { 
            handleTransaction('packing-return-form', 'packing-return-model-id', 'packing-return-qty', (t, d, q, ref) => { 
                if (q > (d.data().packingStockQty || 0)) throw "Return quantity exceeds quantity in packing stock."; 
                t.update(ref, { 
                    packingStockQty: firebase.firestore.FieldValue.increment(-q), 
                    inHandQty: firebase.firestore.FieldValue.increment(q) 
                }); 
            }, 'Product returned from packing to warehouse.'); 
        }
        
        async function submitPackingSend(event) {
            event.preventDefault();
            const docId = document.getElementById('packing-send-model-id').value;
            const qty = Number(document.getElementById('packing-send-qty').value);
            if (!docId || qty <= 0) { alert("Please select a model and quantity."); return; }
            const item = allMaterials.find(m => m.id === docId);
            const docRef = db.collection('materials').doc(docId);
            try {
                await db.runTransaction(async t => {
                    const doc = await t.get(docRef);
                    if (qty > (doc.data().inHandQty || 0)) throw "Send quantity exceeds in-hand warehouse stock.";
                    t.update(docRef, { 
                        inHandQty: firebase.firestore.FieldValue.increment(-qty), 
                        pendingPackingQty: firebase.firestore.FieldValue.increment(qty)
                    });
                    const packingSendRef = db.collection('packing_sends').doc();
                    t.set(packingSendRef, { 
                        materialId: docId, modelName: item.modelName, color: item.color, batchNo: item.batchNo, 
                        quantity: qty, status: 'pending',
                        sentAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                });
                alert('Sent to packing successfully! Awaiting reception by packing team.');
                document.getElementById('packing-send-form').reset();
                await fetchAllMaterials();
            } catch (error) { alert(`Error: ${error}`); }
        }

        async function submitFailToGood(event) {
            event.preventDefault();
            const docId = document.getElementById('f2g-model-id').value;
            const qty = Number(document.getElementById('f2g-qty').value);
            const failType = document.getElementById('f2g-fail-type').value;
            if (!docId || qty <= 0) { alert("Please select a model and enter a valid quantity."); return; }
            const docRef = db.collection('materials').doc(docId);
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (!doc.exists) throw "Product not found!";
                    const data = doc.data();
                    let updateData = {};
                    if (failType === 'production') {
                        if (qty > (data.failQty || 0)) throw `Cannot convert ${qty} pcs. Only ${data.failQty || 0} pcs available in Production Fail stock.`;
                        updateData = {
                            failQty: firebase.firestore.FieldValue.increment(-qty),
                            inHandQty: firebase.firestore.FieldValue.increment(qty)
                        };
                    } else {
                        if (qty > (data.faultyQty || 0)) throw `Cannot convert ${qty} pcs. Only ${data.faultyQty || 0} pcs available in Packing Fail stock.`;
                        updateData = {
                            faultyQty: firebase.firestore.FieldValue.increment(-qty),
                            inHandQty: firebase.firestore.FieldValue.increment(qty)
                        };
                    }
                    transaction.update(docRef, updateData);
                });
                alert(`${qty} pcs successfully converted to good stock and added to warehouse!`);
                document.getElementById('fail-to-good-form').reset();
                await fetchAllMaterials();
            } catch (error) { alert(`Error: ${error}`); }
        }

        // --- Reception and Notification Logic ---
        async function fetchPendingReceptions() {
            const tbody = document.getElementById('receive-table-body');
            tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
            db.collection('production_entries').where('status', '==', 'pending').orderBy('producedAt', 'desc')
                .onSnapshot(snapshot => {
                    let html = '';
                    if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="6">No pending items to receive.</td></tr>'; return; }
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const date = item.producedAt ? item.producedAt.toDate().toLocaleString() : 'N/A';
                        html += `<tr><td>${date}</td><td>${item.modelName}</td><td>${item.batchNo || 'N/A'}</td><td>${item.color}</td><td>${item.quantity}</td><td><button class="btn" onclick="receiveProduct('${doc.id}', '${item.materialId}', ${item.quantity})">Receive</button></td></tr>`;
                    });
                    tbody.innerHTML = html;
                });
        }

        async function receiveProduct(entryId, materialId, qty) {
            if (!confirm(`Are you sure you want to receive ${qty} pcs?`)) return;
            const entryRef = db.collection('production_entries').doc(entryId);
            const materialRef = db.collection('materials').doc(materialId);
            try {
                await db.runTransaction(async (t) => {
                    t.update(entryRef, { status: 'received', receivedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    t.update(materialRef, {
                        pendingReceptionQty: firebase.firestore.FieldValue.increment(-qty),
                        inHandQty: firebase.firestore.FieldValue.increment(qty)
                    });
                });
                alert('Product received successfully and added to warehouse stock!');
                await fetchAllMaterials();
            } catch (error) { alert('Error receiving product: ' + error); }
        }

        async function fetchPendingPackingItems() {
             const tbody = document.getElementById('packing-receive-table-body');
             tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
             db.collection('packing_sends').where('status', '==', 'pending').orderBy('sentAt', 'desc')
                .onSnapshot(snapshot => {
                     let html = '';
                     if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="6">No items awaiting reception.</td></tr>'; return; }
                     snapshot.forEach(doc => {
                         const item = doc.data();
                         const date = item.sentAt ? item.sentAt.toDate().toLocaleString() : 'N/A';
                         html += `<tr><td>${date}</td><td>${item.modelName}</td><td>${item.batchNo || 'N/A'}</td><td>${item.color}</td><td>${item.quantity}</td><td><button class="btn" onclick="receiveForPacking('${doc.id}', '${item.materialId}', ${item.quantity})">Receive</button></td></tr>`;
                     });
                     tbody.innerHTML = html;
                });
        }

        async function receiveForPacking(packingSendId, materialId, qty) {
            if (!confirm(`Are you sure you want to receive ${qty} pcs for packing?`)) return;
            const packingSendRef = db.collection('packing_sends').doc(packingSendId);
            const materialRef = db.collection('materials').doc(materialId);
            try {
                 await db.runTransaction(async (t) => {
                     t.update(packingSendRef, { status: 'received', receivedAt: firebase.firestore.FieldValue.serverTimestamp() });
                     t.update(materialRef, {
                         pendingPackingQty: firebase.firestore.FieldValue.increment(-qty),
                         packingStockQty: firebase.firestore.FieldValue.increment(qty)
                     });
                 });
                 alert('Item received successfully and added to packing stock!');
                 await fetchAllMaterials();
            } catch (error) { alert('Error: ' + error); }
        }

        function setupNotificationListeners() {
            db.collection('production_entries').where('status', '==', 'pending').onSnapshot(snap => {
                const count = snap.size;
                const noti = document.getElementById('reception-noti');
                if (count > 0 && currentUserPermissions.canReceiveProduction) { noti.textContent = count; noti.style.display = 'inline-block'; } 
                else { noti.style.display = 'none'; }
            });
             db.collection('packing_sends').where('status', '==', 'pending').onSnapshot(snap => {
                const count = snap.size;
                const noti = document.getElementById('packing-receive-noti');
                if (count > 0 && currentUserPermissions.canReceiveForPacking) { noti.textContent = count; noti.style.display = 'inline-block'; } 
                else { noti.style.display = 'none'; }
            });
        }
        
        // --- Dashboard and Reporting ---
        async function loadDashboard() {
            let totalTarget = 0, totalProd = 0, totalFail = 0, totalInHand = 0, totalPackingStock = 0, pendingPacking = 0;
            allMaterials.forEach(item => {
                const currentProd = (item.inHandQty || 0) + (item.pendingPackingQty || 0) + (item.packingStockQty || 0);
                item.totalProduction = currentProd;
                item.achievement = item.targetQty > 0 ? (currentProd / item.targetQty) * 100 : 0;
                totalTarget += item.targetQty || 0;
                totalProd += currentProd;
                totalInHand += item.inHandQty || 0;
                pendingPacking += item.pendingPackingQty || 0;
                totalPackingStock += item.packingStockQty || 0;
                totalFail += (item.faultyQty || 0) + (item.failQty || 0);
            });
            const overallAchievement = totalTarget > 0 ? ((totalProd / totalTarget) * 100).toFixed(1) : 0;
            document.getElementById('kpi-achievement').textContent = `${overallAchievement}%`;
            document.getElementById('kpi-total-production').textContent = totalProd;
            document.getElementById('kpi-total-in-hand').textContent = totalInHand;
            document.getElementById('kpi-total-fail').textContent = totalFail;
            renderProductionChart(allMaterials);
            renderStockDonutChart({ totalInHand, pendingPacking, totalPackingStock });
            renderPerformanceTables(allMaterials);
            fetchRecentActivities();
        }

        function renderProductionChart(data) {
            const ctx = document.getElementById('productionChart').getContext('2d');
            const labels = data.map(item => `${item.modelName} (${item.color})`);
            const targetData = data.map(item => item.targetQty || 0);
            const productionData = data.map(item => item.totalProduction || 0);
            if (productionChartInstance) { productionChartInstance.destroy(); }
            productionChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'Target Quantity', data: targetData, backgroundColor: 'rgba(52, 152, 219, 0.5)', borderColor: 'rgba(52, 152, 219, 1)', borderWidth: 1 }, { label: 'Total Production', data: productionData, backgroundColor: 'rgba(39, 174, 96, 0.8)', borderColor: 'rgba(39, 174, 96, 1)', borderWidth: 1 } ] }, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
        }

        function renderStockDonutChart(stockData) {
            const ctx = document.getElementById('stockDonutChart').getContext('2d');
            if (stockDonutChartInstance) { stockDonutChartInstance.destroy(); }
            stockDonutChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['In Warehouse', 'Pending for Packing', 'In Packing Stock'], datasets: [{ label: 'Stock Distribution', data: [stockData.totalInHand, stockData.pendingPacking, stockData.totalPackingStock], backgroundColor: ['rgba(46, 204, 113, 0.8)', 'rgba(243, 156, 18, 0.8)', 'rgba(52, 152, 219, 0.8)'], hoverOffset: 4 }] }, options: { responsive: true } });
        }

        function renderPerformanceTables(data) {
            const sortedByTop = [...data].sort((a, b) => b.achievement - a.achievement);
            const topTableBody = document.getElementById('top-models-table');
            topTableBody.innerHTML = '';
            sortedByTop.slice(0, 5).forEach(item => { topTableBody.innerHTML += `<tr><td>${item.modelName} (${item.color})</td><td class="good-performance">${item.achievement.toFixed(1)}%</td></tr>`; });
            const sortedByAttention = [...data].filter(i => i.achievement < 100).sort((a, b) => a.achievement - b.achievement);
            const attentionTableBody = document.getElementById('attention-models-table');
            attentionTableBody.innerHTML = '';
            sortedByAttention.slice(0, 5).forEach(item => { attentionTableBody.innerHTML += `<tr><td>${item.modelName} (${item.color})</td><td class="bad-performance">${item.achievement.toFixed(1)}%</td></tr>`; });
        }

        async function fetchRecentActivities() {
            const logContainer = document.getElementById('recent-activity-log');
            logContainer.innerHTML = '<p>Loading activities...</p>';
            try {
                const prodSnapshot = await db.collection('production_entries').orderBy('producedAt', 'desc').limit(3).get();
                const packSnapshot = await db.collection('packing_sends').orderBy('sentAt', 'desc').limit(2).get();
                let activities = [];
                prodSnapshot.forEach(doc => { activities.push({ text: `<b>${doc.data().quantity}pcs</b> ${doc.data().modelName} produced`, time: doc.data().producedAt.toDate() }); });
                packSnapshot.forEach(doc => { activities.push({ text: `<b>${doc.data().quantity}pcs</b> ${doc.data().modelName} sent to packing`, time: doc.data().sentAt.toDate() }); });
                activities.sort((a, b) => b.time - a.time);
                if (activities.length === 0) { logContainer.innerHTML = '<p>No recent activities.</p>'; return; }
                logContainer.innerHTML = '';
                activities.slice(0, 5).forEach(activity => { logContainer.innerHTML += `<div class="activity-log-item"><span>${activity.text}</span><span class="time">${activity.time.toLocaleTimeString()}</span></div>`; });
            } catch (error) { console.error("Error fetching recent activities:", error); logContainer.innerHTML = '<p>Could not load activities.</p>'; }
        }
        
        function renderMasterReport() {
            const thead = document.getElementById('master-report-head');
            if(thead) { thead.innerHTML = `<tr><th>Model</th><th>Batch</th><th>Color</th><th>Target</th><th>Pending Reception</th><th>In Warehouse</th><th>Pending Packing</th><th>Packing Stock</th><th>Total Fail</th><th>Remaining</th></tr>`; }
            const tbody = document.getElementById('report-table-body');
            let html = '';
            allMaterials.forEach(i => {
                const t = i.targetQty || 0, pendingRec = i.pendingReceptionQty || 0, h = i.inHandQty || 0,
                      pendingPack = i.pendingPackingQty || 0, packStock = i.packingStockQty || 0,
                      f = (i.faultyQty || 0) + (i.failQty || 0), achieved = h + pendingPack + packStock,
                      r = t - achieved;
                html += `<tr><td>${i.modelName}</td><td>${i.batchNo||'N/A'}</td><td>${i.color}</td><td>${t}</td><td>${pendingRec}</td><td>${h}</td><td>${pendingPack}</td><td>${packStock}</td><td>${f}</td><td>${r>0?r:0}</td></tr>`;
            });
            tbody.innerHTML = html || `<tr><td colspan="10">No data found.</td></tr>`;
        }
        
        async function fetchPackingSendReport() {
            const tbody = document.querySelector('#packing-send-report .styled-table tbody');
            if(!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            const snapshot = await db.collection('packing_sends').orderBy('sentAt', 'desc').get();
            let html = '';
            snapshot.forEach(doc => {
                const item = doc.data();
                const date = item.sentAt ? item.sentAt.toDate().toLocaleString() : 'N/A';
                html += `<tr><td>${date}</td><td>${item.modelName}</td><td>${item.batchNo||'N/A'}</td><td>${item.color}</td><td>${item.quantity}</td></tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="5">No data found.</td></tr>';
        }

        // --- নতুন ফিল্টার এবং প্রিন্ট ফাংশন ---
        function toggleFilterSection() {
            const filterOptions = document.getElementById('filter-options');
            filterOptions.classList.toggle('active');
        }

        function applyMasterReportFilters() {
            const modelFilter = document.getElementById('filter-model').value.toUpperCase();
            const batchFilter = document.getElementById('filter-batch').value.toUpperCase();
            const tbody = document.getElementById("report-table-body");
            const tr = tbody.getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                const modelTd = tr[i].getElementsByTagName("td")[0];
                const batchTd = tr[i].getElementsByTagName("td")[1];
                if (modelTd && batchTd) {
                    const modelText = (modelTd.textContent || modelTd.innerText).toUpperCase();
                    const batchText = (batchTd.textContent || batchTd.innerText).toUpperCase();
                    const modelMatch = modelText.indexOf(modelFilter) > -1;
                    const batchMatch = batchText.indexOf(batchFilter) > -1;
                    if (modelMatch && batchMatch) { tr[i].style.display = ""; } 
                    else { tr[i].style.display = "none"; }
                }
            }
        }

        function clearMasterReportFilters() {
            document.getElementById('filter-model').value = '';
            document.getElementById('filter-batch').value = '';
            applyMasterReportFilters();
        }
    </script>
</body>
</html>
